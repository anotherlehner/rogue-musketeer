function t(t,e,i,s){Object.defineProperty(t,e,{get:i,set:s,enumerable:!0,configurable:!0})}class e{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*23283064365386963e-26,t=69069*t+1>>>0,this._s1=23283064365386963e-26*t,t=69069*t+1>>>0,this._s2=23283064365386963e-26*t,this._c=1,this}getUniform(){let t=2091639*this._s0+23283064365386963e-26*this._c;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,r;do r=(i=2*this.getUniform()-1)*i+(s=2*this.getUniform()-1)*s;while(r>1||0==r)return t+i*Math.sqrt(-2*Math.log(r)/r)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i=this.getUniform()*e,s,r=0;for(s in t)if(i<(r+=t[s]))break;return s}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return new e().setState(this.getState())}}var i,s,r,o,n,a,l,h=new e().setSeed(Date.now());class c{getContainer(){return null}setOptions(t){this._options=t}}class u extends c{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);let e=t.fontStyle?`${t.fontStyle} `:"",i=`${e} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=i,this._updateSize(),this._ctx.font=i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){let t=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=t}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return(t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height)?[-1,-1]:this._normalizedEventToPosition(t,e)}}var d={};function p(t,e){return(t%e+e)%e}function g(t,e=0,i=1){return t<e?e:t>i?i:t}function _(t){return t.charAt(0).toUpperCase()+t.substring(1)}function f(t,...e){let i=f.map;return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(s,r,o,n){if("%"==t.charAt(n-1))return s.substring(1);if(!e.length)return s;let a=e[0],l=(r||o).split(","),h=l.shift()||"",c=i[h.toLowerCase()];if(!c)return s;let u=(a=e.shift())[c].apply(a,l),d=h.charAt(0);return d!=d.toLowerCase()&&(u=_(u)),u})}t(d,"mod",()=>p),t(d,"clamp",()=>g),t(d,"capitalize",()=>_),t(d,"format",()=>f),f.map={s:"toString"};class m extends u{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,r,o,n]=t,a=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=n,this._fill(a[0],a[1])),!r)return;this._ctx.fillStyle=o;let l=[].concat(r);for(let t=0;t<l.length;t++)this._ctx.fillText(l[t],a[0],Math.ceil(a[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,e=t-e,t-=e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,e=t-e,t-=e);let i=Math.min(2*t/((this._options.width+1)*Math.sqrt(3))-1,e/(2+1.5*(this._options.height-1))),s=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);return this._ctx.font=s,Math.ceil(2*(i=Math.floor(i)+1)/(this._options.spacing*(1+r/100/Math.sqrt(3))))-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,e=t-e,t-=e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return p(e=Math.floor(e/s),2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border,r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-i+s,e),r.lineTo(t-i/2+s,e+this._spacingX-s),r.lineTo(t+i/2-s,e+this._spacingX-s),r.lineTo(t+i-s,e),r.lineTo(t+i/2-s,e-this._spacingX+s),r.lineTo(t-i/2+s,e-this._spacingX+s),r.lineTo(t-i+s,e)):(r.moveTo(t,e-i+s),r.lineTo(t+this._spacingX-s,e-i/2+s),r.lineTo(t+this._spacingX-s,e+i/2-s),r.lineTo(t,e+i-s),r.lineTo(t-this._spacingX+s,e+i/2-s),r.lineTo(t-this._spacingX+s,e-i/2+s),r.lineTo(t,e-i+s)),r.fill()}_updateSize(){let t,e,i=this._options,s=Math.ceil(this._ctx.measureText("W").width);this._hexSize=Math.floor(i.spacing*(i.fontSize+s/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,i.transpose?(t="height",e="width"):(t="width",e="height"),this._ctx.canvas[t]=Math.ceil((i.width+1)*this._spacingX),this._ctx.canvas[e]=Math.ceil((i.height-1)*this._spacingY+2*this._hexSize)}}class y extends u{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){y.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,r,o,n]=t,a=""+r+o+n;if(a in this._canvasCache)e=this._canvasCache[a];else{let t=this._options.border,i=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=n,i.fillRect(t,t,e.width-t,e.height-t),r){i.fillStyle=o,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(r);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,r,o,n]=t;if(e){let t=this._options.border;this._ctx.fillStyle=n,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!r)return;this._ctx.fillStyle=o;let a=[].concat(r);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let n=o/100*s/i;return n>1&&(s=Math.floor(s/n)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){let t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}y.cache=!1;class w extends u{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,r,o,n]=t,a=this._options.tileWidth,l=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*a,s*l,a,l):(this._ctx.fillStyle=n,this._ctx.fillRect(i*a,s*l,a,l))),!r)return;let h=[].concat(r),c=[].concat(o),u=[].concat(n);for(let t=0;t<h.length;t++){let e=this._options.tileMap[h[t]];if(!e)throw Error(`Char "${h[t]}" not found in tileMap`);if(this._options.tileColorize){let r=this._colorCanvas,o=r.getContext("2d");o.globalCompositeOperation="source-over",o.clearRect(0,0,a,l);let n=c[t],h=u[t];o.drawImage(this._options.tileSet,e[0],e[1],a,l,0,0,a,l),"transparent"!=n&&(o.fillStyle=n,o.globalCompositeOperation="source-atop",o.fillRect(0,0,a,l)),"transparent"!=h&&(o.fillStyle=h,o.globalCompositeOperation="destination-over",o.fillRect(0,0,a,l)),this._ctx.drawImage(r,i*a,s*l,a,l)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],a,l,i*a,s*l,a,l)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){let t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}var b={};function A(t){let e,i;if(t in z)e=z[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];z[t]=e}return e.slice()}function T(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let s=0;s<e.length;s++)i[t]+=e[s][t];return i}function E(t,...e){for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}function x(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let s=0;s<e.length;s++)i[t]*=e[s][t]/255;i[t]=Math.round(i[t])}return i}function v(t,...e){for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t}function S(t,e,i=.5){let s=t.slice();for(let r=0;r<3;r++)s[r]=Math.round(s[r]+i*(e[r]-t[r]));return s}t(b,"fromString",()=>A),t(b,"add",()=>T),t(b,"add_",()=>E),t(b,"multiply",()=>x),t(b,"multiply_",()=>v),t(b,"interpolate",()=>S),t(b,"lerp",()=>R),t(b,"interpolateHSL",()=>M),t(b,"rgb2hsl",()=>k),t(b,"hsl2rgb",()=>L),t(b,"lerpHSL",()=>O),t(b,"randomize",()=>C),t(b,"toRGB",()=>N),t(b,"toHex",()=>U);let R=S;function M(t,e,i=.5){let s=k(t),r=k(e);for(let t=0;t<3;t++)s[t]+=i*(r[t]-s[t]);return L(s)}let O=M;function C(t,e){e instanceof Array||(e=Math.round(h.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(h.getNormal(0,e[t])):e;return i}function k(t){let e=t[0]/255,i=t[1]/255,s=t[2]/255,r=Math.max(e,i,s),o=Math.min(e,i,s),n=0,a,l=(r+o)/2;if(r==o)a=0;else{let t=r-o;switch(a=l>.5?t/(2-r-o):t/(r+o),r){case e:n=(i-s)/t+6*(i<s);break;case i:n=(s-e)/t+2;break;case s:n=(e-i)/t+4}n/=6}return[n,a,l]}function P(t,e,i){return(i<0&&(i+=1),i>1&&(i-=1),i<1/6)?t+(e-t)*6*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function L(t){let e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];{let i=t[1],s=e<.5?e*(1+i):e+i-e*i,r=2*e-s;return[Math.round(255*P(r,s,t[0]+1/3)),Math.round(255*P(r,s,t[0])),Math.round(255*P(r,s,t[0]-1/3))]}}function N(t){let e=t.map(t=>g(t,0,255));return`rgb(${e.join(",")})`}function U(t){let e=t.map(t=>g(t,0,255).toString(16).padStart(2,"0"));return`#${e.join("")}`}let z={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]};class W extends c{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){"string"==typeof t?alert(t):t instanceof Error&&alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){let i=this._gl,s=this._options,[r,o,n,a,l]=t,h=i.canvas.height-(o+1)*s.tileHeight;if(i.scissor(r*s.tileWidth,h,s.tileWidth,s.tileHeight),e&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...Y(l)),i.clear(i.COLOR_BUFFER_BIT)),!n)return;let c=[].concat(n),u=[].concat(l),d=[].concat(a);i.uniform2fv(this._uniforms.targetPosRel,[r,o]);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw Error(`Char "${c[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,+!!s.tileColorize),i.uniform2fv(this._uniforms.tilesetPosAbs,e),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,Y(d[t])),i.uniform4fv(this._uniforms.bg,Y(u[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){let t=this._gl;t.clearColor(...Y(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,s=i.getBoundingClientRect();return(t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height)?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){var t;let e,i,s=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=s;let r=function(t,e,i){let s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw Error(t.getShaderInfoLog(s)||"");let r=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw Error(t.getShaderInfoLog(r)||"");let o=t.createProgram();if(t.attachShader(o,s),t.attachShader(o,r),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(t.getProgramInfoLog(o)||"");return o}(s,D,X);return s.useProgram(r),t=s,e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),I.forEach(t=>this._uniforms[t]=s.getUniformLocation(r,t)),this._program=r,s.enable(s.BLEND),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.enable(s.SCISSOR_TEST),s}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){let t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){var e,i;let s;e=this._gl,i=t,s=e.createTexture(),e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i)}}let I=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],D=`
#version 300 es

in vec2 tilePosRel;
out vec2 tilesetPosPx;

uniform vec2 tilesetPosAbs;
uniform vec2 tileSize;
uniform vec2 targetSize;
uniform vec2 targetPosRel;

void main() {
	vec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;
	vec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;
	targetPosNdc.y *= -1.0;

	gl_Position = vec4(targetPosNdc, 0.0, 1.0);
	tilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;
}`.trim(),X=`
#version 300 es
precision highp float;

in vec2 tilesetPosPx;
out vec4 fragColor;
uniform sampler2D image;
uniform bool colorize;
uniform vec4 bg;
uniform vec4 tint;

void main() {
	fragColor = vec4(0, 0, 0, 1);

	vec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);

	if (colorize) {
		texel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;
		fragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;
		fragColor.a = texel.a + (1.0-texel.a)*bg.a;
	} else {
		fragColor = texel;
	}
}`.trim(),F={};function Y(t){if(!(t in F)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else(e=A(t).map(t=>t/255)).push(1);F[t]=e}return F[t]}var $={},B=$={};function H(){throw Error("setTimeout has not been defined")}function G(){throw Error("clearTimeout has not been defined")}try{n="function"==typeof setTimeout?setTimeout:H}catch(t){n=H}try{a="function"==typeof clearTimeout?clearTimeout:G}catch(t){a=G}function q(t){if(n===setTimeout)return setTimeout(t,0);if((n===H||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}var V=[],j=!1,K=-1;function J(){j&&l&&(j=!1,l.length?V=l.concat(V):K=-1,V.length&&Q())}function Q(){if(!j){var t=q(J);j=!0;for(var e=V.length;e;){for(l=V,V=[];++K<e;)l&&l[K].run();K=-1,e=V.length}l=null,j=!1,function(t){if(a===clearTimeout)return clearTimeout(t);if((a===G||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(t);try{a(t)}catch(e){try{return a.call(null,t)}catch(e){return a.call(this,t)}}}(t)}}function Z(t,e){this.fun=t,this.array=e}function tt(){}function te(t){let e=A(t);return 36*Math.floor(.0234375*e[0])+6*Math.floor(.0234375*e[1])+ +Math.floor(.0234375*e[2])+16}B.nextTick=function(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];V.push(new Z(t,e)),1!==V.length||j||q(Q)},Z.prototype.run=function(){this.fun.apply(null,this.array)},B.title="browser",B.browser=!0,B.env={},B.argv=[],B.version="",B.versions={},B.on=tt,B.addListener=tt,B.once=tt,B.off=tt,B.removeListener=tt,B.removeAllListeners=tt,B.emit=tt,B.prependListener=tt,B.prependOnceListener=tt,B.listeners=function(t){return[]},B.binding=function(t){throw Error("process.binding is not supported")},B.cwd=function(){return"/"},B.chdir=function(t){throw Error("process.chdir is not supported")},B.umask=function(){return 0};class ti extends c{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){var t;$.stdout.write((t=this._options.bg,`\x1b[0;48;5;${te(t)}m\x1b[2J`))}draw(t,e){let[i,s,r,o,n]=t,a=this._offset[0]+i,l=this._offset[1]+s,h=this.computeSize();if(a<0||a>=h[0]||l<0||l>=h[1])return;if((a!==this._cursor[0]||l!==this._cursor[1])&&($.stdout.write(`\x1b[${l+1};${a+1}H`),this._cursor[0]=a,this._cursor[1]=l),e&&!r&&(r=" "),!r)return;let c=`\x1b[0;38;5;${te(o)};48;5;${te(n)}m`;if(c!==this._lastColor&&($.stdout.write(c),this._lastColor=c),"	"!=r){let t=[].concat(r);$.stdout.write(t[0])}this._cursor[0]++,this._cursor[0]>=h[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[$.stdout.columns,$.stdout.rows]}}var ts={};t(ts,"TYPE_TEXT",()=>to),t(ts,"TYPE_NEWLINE",()=>tn),t(ts,"TYPE_FG",()=>ta),t(ts,"TYPE_BG",()=>tl),t(ts,"measure",()=>th),t(ts,"tokenize",()=>tc);let tr=/%([bc]){([^}]*)}/g,to=0,tn=1,ta=2,tl=3;function th(t,e){let i={width:0,height:1},s=tc(t,e),r=0;for(let t=0;t<s.length;t++){let e=s[t];switch(e.type){case to:r+=e.value.length;break;case tn:i.height++,i.width=Math.max(i.width,r),r=0}}return i.width=Math.max(i.width,r),i}function tc(t,e){let i=[],s=0;t.replace(tr,function(e,r,o,n){let a=t.substring(s,n);return a.length&&i.push({type:to,value:a}),i.push({type:"c"==r?ta:tl,value:o.trim()}),s=n+e.length,""});let r=t.substring(s);return r.length&&i.push({type:to,value:r}),function(t,e){e||(e=1/0);let i=0,s=0,r=-1;for(;i<t.length;){let o=t[i];if(o.type==tn&&(s=0,r=-1),o.type!=to){i++;continue}for(;0==s&&" "==o.value.charAt(0);)o.value=o.value.substring(1);let n=o.value.indexOf("\n");if(-1!=n){o.value=tu(t,i,n,!0);let e=o.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();o.value=e.join("")}if(!o.value.length){t.splice(i,1);continue}if(s+o.value.length>e){let n=-1;for(;;){let t=o.value.indexOf(" ",n+1);if(-1==t||s+t>e)break;n=t}if(-1!=n)o.value=tu(t,i,n,!0);else if(-1!=r){let e=t[r],s=e.value.lastIndexOf(" ");e.value=tu(t,r,s,!0),i=r}else o.value=tu(t,i,e-s,!1)}else s+=o.value.length,-1!=o.value.indexOf(" ")&&(r=i);i++}t.push({type:tn});let o=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case to:o=i;break;case tn:if(o){let t=o.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();o.value=t.join("")}o=null}}return t.pop(),t}(i,e)}function tu(t,e,i,s){let r={type:to,value:t[e].value.substring(i+ +!!s)};return t.splice(e+1,0,{type:tn},r),t[e].value.substring(0,i)}let td={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},tp={hex:m,rect:y,tile:w,"tile-gl":W,term:ti},tg={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class t_{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},tg,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=tp[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,r){s||(s=this._options.fg),r||(r=this._options.bg);let o=`${t},${e}`;this._data[o]=[t,e,i,s,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawOver(t,e,i,s,r){let o=`${t},${e}`,n=this._data[o];n?(n[2]=i||n[2],n[3]=s||n[3],n[4]=r||n[4]):this.draw(t,e,i,s,r)}drawText(t,e,i,s){let r=null,o=null,n=t,a=e,l=1;s||(s=this._options.width-t);let h=tc(i,s);for(;h.length;){let e=h.shift();switch(e.type){case to:let i=!1,s=!1,c=!1,u=!1;for(let t=0;t<e.value.length;t++){let l=e.value.charCodeAt(t),h=e.value.charAt(t);if("term"===this._options.layout){let t=l>>8;if(17===t||t>=46&&t<=159||t>=172&&t<=215||l>=43360&&l<=43391){this.draw(n+0,a,h,r,o),this.draw(n+1,a,"	",r,o),n+=2;continue}}c=l>65280&&l<65377||l>65500&&l<65512||l>65518,i=32==h.charCodeAt(0)||12288==h.charCodeAt(0),u&&!c&&!i&&n++,c&&!s&&n++,this.draw(n++,a,h,r,o),s=i,u=c}break;case ta:r=e.value||null;break;case tl:o=e.value||null;break;case tn:n=t,a++,l++}}return l}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty)for(let t in this._backend.clear(),this._data)this._draw(t,!1);else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}t_.Rect=y,t_.Hex=m,t_.Tile=w,t_.TileGL=W,t_.Term=ti;class tf{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,r,o,n=[];switch(this._options.topology){case 4:r=1,o=[0,1],s=[td[8][7],td[8][1],td[8][3],td[8][5]];break;case 6:s=td[6],r=1,o=[-1,1];break;case 8:s=td[4],r=2,o=[-1,1];break;default:throw Error("Incorrect topology for FOV computation")}let a=t+o[0]*i,l=e+o[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*r;e++)n.push([a,l]),a+=s[t][0],l+=s[t][1];return n}}var tm=class extends tf{compute(t,e,i,s){let r,o,n,a,l,h;if(s(t,e,0,1),!this._lightPasses(t,e))return;let c=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),d=i.length;for(let t=0;t<d;t++)if(r=i[t][0],o=i[t][1],a=[t?2*t-1:2*d-1,2*d],l=[2*t+1,2*d],n=!this._lightPasses(r,o),(h=this._checkVisibility(a,l,n,c))&&s(r,o,u,h),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,s){let r;if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let o=0,n=!1;for(;o<s.length;){let e=s[o],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||o%2||(n=!0);break}o++}let a=s.length,l=!1;for(;a--;){let t=s[a],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&a%2&&(l=!0);break}}let h=!0;if(o==a&&(n||l)||n&&l&&o+1==a&&a%2?h=!1:o>a&&o%2&&(h=!1),!h)return 0;let c=a-o+1;if(c%2)if(o%2){let t=s[o];r=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(o,c,e)}else{let e=s[a];r=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(o,c,t)}else{if(!(o%2))return i&&s.splice(o,c,t,e),1;let n=s[o],l=s[a];r=(l[0]*n[1]-n[0]*l[1])/(n[1]*l[1]),i&&s.splice(o,c)}return r/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}};class ty{constructor(t=80,e=25){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let s=0;s<this._height;s++)e[i].push(t)}return e}}class tw extends ty{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class tb{}class tA extends tb{constructor(t,e,i,s,r,o){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=s,this._doors={},void 0!==r&&void 0!==o&&this.addDoor(r,o)}static createRandomAt(t,e,i,s,r){let o=r.roomWidth[0],n=r.roomWidth[1],a=h.getUniformInt(o,n);o=r.roomHeight[0],n=r.roomHeight[1];let l=h.getUniformInt(o,n);if(1==i){let i=e-Math.floor(h.getUniform()*l);return new this(t+1,i,t+a,i+l-1,t,e)}if(-1==i){let i=e-Math.floor(h.getUniform()*l);return new this(t-a,i,t-1,i+l-1,t,e)}if(1==s){let i=t-Math.floor(h.getUniform()*a);return new this(i,e+1,i+a-1,e+l,t,e)}if(-1==s){let i=t-Math.floor(h.getUniform()*a);return new this(i,e-l,i+a-1,e-1,t,e)}throw Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let s=i.roomWidth[0],r=i.roomWidth[1],o=h.getUniformInt(s,r);s=i.roomHeight[0],r=i.roomHeight[1];let n=h.getUniformInt(s,r),a=t-Math.floor(h.getUniform()*o),l=e-Math.floor(h.getUniform()*n);return new this(a,l,a+o-1,l+n-1)}static createRandom(t,e,i){let s=i.roomWidth[0],r=i.roomWidth[1],o=h.getUniformInt(s,r);s=i.roomHeight[0],r=i.roomHeight[1];let n=h.getUniformInt(s,r),a=1+Math.floor(h.getUniform()*(t-o-1)),l=1+Math.floor(h.getUniform()*(e-n-1));return new this(a,l,a+o-1,l+n-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,r=this._y2+1;for(let o=e;o<=i;o++)for(let n=s;n<=r;n++)(o==e||o==i||n==s||n==r)&&(t(o,n)||this.addDoor(o,n));return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,s=this._x2+1,r=this._y1-1,o=this._y2+1;for(let n=i;n<=s;n++)for(let a=r;a<=o;a++)if(n==i||n==s||a==r||a==o){if(!t(n,a))return!1}else if(!e(n,a))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,r=this._y2+1,o=0;for(let n=e;n<=i;n++)for(let a=s;a<=r;a++)o=n+","+a in this._doors?2:+(n==e||n==i||a==s||a==r),t(n,a,o)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class tT extends tb{constructor(t,e,i,s){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=s,this._endsWithAWall=!0}static createRandomAt(t,e,i,s,r){let o=r.corridorLength[0],n=r.corridorLength[1],a=h.getUniformInt(o,n);return new this(t,e,t+i*a,e+s*a)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,s=this._startY,r=this._endX-i,o=this._endY-s,n=1+Math.max(Math.abs(r),Math.abs(o));r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));let a=o,l=-r,h=!0;for(let c=0;c<n;c++){let u=i+c*r,d=s+c*o;if(e(u,d)||(h=!1),t(u+a,d+l)||(h=!1),t(u-a,d-l)||(h=!1),!h){n=c,this._endX=u-r,this._endY=d-o;break}}if(0==n||1==n&&t(this._endX+r,this._endY+o))return!1;let c=!t(this._endX+r+a,this._endY+o+l),u=!t(this._endX+r-a,this._endY+o-l);return this._endsWithAWall=t(this._endX+r,this._endY+o),!c&&!u||!this._endsWithAWall}create(t){let e=this._startX,i=this._startY,s=this._endX-e,r=this._endY-i,o=1+Math.max(Math.abs(s),Math.abs(r));s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));for(let n=0;n<o;n++)t(e+n*s,i+n*r,0);return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,s=this._endX-e,r=this._endY-i;s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));let o=r,n=-s;t(this._endX+s,this._endY+r),t(this._endX+o,this._endY+n),t(this._endX-o,this._endY-n)}}class tE extends tw{constructor(t,e,i){super(t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,i),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(t){let e=Date.now();for(;;){if(Date.now()-e>this._options.timeLimit)return null;if((this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2))&&this._generateCorridors())break}if(t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this}_generateRooms(){let t,e=this._width-2,i=this._height-2;do if(t=this._generateRoom(),this._dug/(e*i)>this._options.roomDugPercentage)break;while(t)}_generateRoom(){let t=0;for(;t<this._roomAttempts;){t++;let e=tA.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null}_generateCorridors(){let t=0;for(;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(let t=0;t<this._rooms.length;t++){let e=this._rooms[t];e.clearDoors(),e.create(this._digCallback)}for(this._unconnected=h.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let t=h.getItem(this._connected);if(!t)break;let e=this._closestRoom(this._unconnected,t);if(!e)break;let i=this._closestRoom(this._connected,e);if(!i||!this._connectRooms(e,i))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(t,e){let i=1/0,s=e.getCenter(),r=null;for(let e=0;e<t.length;e++){let o=t[e],n=o.getCenter(),a=n[0]-s[0],l=n[1]-s[1],h=a*a+l*l;h<i&&(i=h,r=o)}return r}_connectRooms(t,e){let i,s,r,o,n,a,l,h=t.getCenter(),c=e.getCenter(),u=c[0]-h[0],d=c[1]-h[1];if(Math.abs(u)<Math.abs(d)?(o=((r=2*(d>0))+2)%4,n=e.getLeft(),a=e.getRight(),l=0):(o=((r=u>0?1:3)+2)%4,n=e.getTop(),a=e.getBottom(),l=1),!(i=this._placeInWall(t,r)))return!1;if(i[l]>=n&&i[l]<=a){s=i.slice();let t=0;switch(o){case 0:t=e.getTop()-1;break;case 1:t=e.getRight()+1;break;case 2:t=e.getBottom()+1;break;case 3:t=e.getLeft()-1}s[(l+1)%2]=t,this._digLine([i,s])}else if(i[l]<n-1||i[l]>a+1){let t=i[l]-c[l],r=0;switch(o){case 0:case 1:r=t<0?3:1;break;case 2:case 3:r=t<0?1:3}if(o=(o+r)%4,!(s=this._placeInWall(e,o)))return!1;let n=[0,0];n[l]=i[l];let a=(l+1)%2;n[a]=s[a],this._digLine([i,n,s])}else{let t=(l+1)%2;if(!(s=this._placeInWall(e,o)))return!1;let r=Math.round((s[t]+i[t])/2),n=[0,0],a=[0,0];n[l]=i[l],n[t]=r,a[l]=s[l],a[t]=r,this._digLine([i,n,a,s])}return t.addDoor(i[0],i[1]),e.addDoor(s[0],s[1]),-1!=(l=this._unconnected.indexOf(t))&&(this._unconnected.splice(l,1),this._connected.push(t)),-1!=(l=this._unconnected.indexOf(e))&&(this._unconnected.splice(l,1),this._connected.push(e)),!0}_placeInWall(t,e){let i=[0,0],s=[0,0],r=0;switch(e){case 0:s=[1,0],i=[t.getLeft(),t.getTop()-1],r=t.getRight()-t.getLeft()+1;break;case 1:s=[0,1],i=[t.getRight()+1,t.getTop()],r=t.getBottom()-t.getTop()+1;break;case 2:s=[1,0],i=[t.getLeft(),t.getBottom()+1],r=t.getRight()-t.getLeft()+1;break;case 3:s=[0,1],i=[t.getLeft()-1,t.getTop()],r=t.getBottom()-t.getTop()+1}let o=[],n=-2;for(let t=0;t<r;t++){let e=i[0]+t*s[0],r=i[1]+t*s[1];o.push(null),1==this._map[e][r]?n!=t-1&&(o[t]=[e,r]):(n=t,t&&(o[t-1]=null))}for(let t=o.length-1;t>=0;t--)o[t]||o.splice(t,1);return o.length?h.getItem(o):null}_digLine(t){for(let e=1;e<t.length;e++){let i=t[e-1],s=t[e],r=new tT(i[0],i[1],s[0],s[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(t,e,i){this._map[t][e]=i,0==i&&this._dug++}_isWallCallback(t,e){return!(t<0)&&!(e<0)&&!(t>=this._width)&&!(e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1)&&!(e<1)&&!(t+1>=this._width)&&!(e+1>=this._height)&&1==this._map[t][e]}}class tx{constructor(t,e,i,s={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},s),this._dirs=td[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let s=0;s<this._dirs.length;s++){let r=this._dirs[s],o=t+r[0],n=e+r[1];this._passableCallback(o,n)&&i.push([o,n])}return i}}var tv=class extends tx{constructor(t,e,i,s){super(t,e,i,s),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let s=t+","+e;if(s in this._computed||this._compute(t,e),!(s in this._computed))return;let r=this._computed[s];for(;r;)i(r.x,r.y),r=r.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let s=this._getNeighbors(i.x,i.y);for(let t=0;t<s.length;t++){let e=s[t],r=e[0],o=e[1];r+","+o in this._computed||this._add(r,o,i)}}}_add(t,e,i){let s={x:t,y:e,prev:i};this._computed[t+","+e]=s,this._todo.push(s)}};let tS="#666",tR="#e6928c",tM="#8cb5e6",tO="#f2bf27",tC=[40,38,37,39];var tk=((i={})[i.AI=0]="AI",i[i.PLAYER=1]="PLAYER",i[i.CREATURE=2]="CREATURE",i[i.HEALTH_BONUS=3]="HEALTH_BONUS",i[i.ARMOR_BONUS_1=4]="ARMOR_BONUS_1",i[i.ARMOR_BONUS_2=5]="ARMOR_BONUS_2",i[i.AMMO_WAND=6]="AMMO_WAND",i[i.GAUNTLETS=7]="GAUNTLETS",i),tP=((s={})[s.NONE=0]="NONE",s[s.STAFF=1]="STAFF",s[s.GAUNTLETS=2]="GAUNTLETS",s[s.ELVEN_WAND=3]="ELVEN_WAND",s);class tL{static between(t,e){return tL.betweenCoordinates(t.x,t.y,e.x,e.y)}static betweenCoordinates(t,e,i,s){return Math.sqrt((i-t)**2+(s-e)**2)}}class tN{constructor(t,e){this.x=t,this.y=e}equals(t){return t&&this.x===t.x&&this.y===t.y}equalsCoords(t,e){return this.x===t&&this.y===e}set(t,e){this.x=t,this.y=e}encoded(){return tN.encode(this.x,this.y)}distanceTo(t){return tL.between(this,t)}static encode(t,e){return t+","+e}}class tU{constructor(t){this.age=0,this.content=t}}class tz{addAmmo(t,e){3===t&&(this.wandAmmo+=e)}decAmmo(t){3===t&&(this.wandAmmo-=1)}getAmmo(t){switch(t){case 1:case 0:case 2:return -1;case 3:return this.wandAmmo}}constructor(){this.wandAmmo=0,this.weapons=[]}}var tW=((r={})[r.FLOOR=0]="FLOOR",r[r.WALL=1]="WALL",r[r.STAIRS=2]="STAIRS",r[r.DOOR=3]="DOOR",r);let tI=[tk.HEALTH_BONUS,tk.ARMOR_BONUS_1,tk.ARMOR_BONUS_2,tk.AMMO_WAND,tk.GAUNTLETS];class tD{constructor(t,e,i,s){this.x=t,this.y=e,this.passable=i,this.seen=s,this.type=+!i}description(){switch(this.type){case 0:return"floor";case 1:return"wall";case 2:return"stairs leading down"}}glyf(){switch(this.type){case 2:return">";case 3:return this.passable?"-":"+";default:return""}}}class tX{constructor(t,e){this.entities=[],this.tiles=new Map,this.map=new tE(t,e,{}),this.map.create((t,e,i)=>{this.tiles[t+","+e]=new tD(t,e,1!=i,!1)}),this.map.getRooms().forEach(t=>{console.log(t),t.getDoors((t,e)=>{if(h.getUniform()>.75){let i=this.tiles[tN.encode(t,e)];i.type=3,i.passable=!1}})});let i=this.getRandomPassablePosition();this.tiles[i.encoded()].type=2}getTileAt(t){return this.tiles[t.encoded()]}isMapPassableAt(t){if(!t)return!1;{let e=t.encoded();return e in this.tiles&&this.tiles[e].passable}}isEntitiesPassableAt(t){for(let e=0;e<this.entities.length;e++){let i=this.entities[e];if(i.position.equals(t)&&!i.passable)return!1}return!0}isPassableEmptyAt(t){return this.isMapPassableAt(t)&&0==this.getEntitiesAt(t).length}isPassableAt(t){return this.isMapPassableAt(t)&&this.isEntitiesPassableAt(t)}getRandomPassablePosition(){let t;for(let e=0;e<100;e++){let e=h.getItem(Object.values(this.tiles));this.isPassableAt(new tN(e.x,e.y))&&(t=new tN(e.x,e.y))}if(t)return t;throw"ERROR: couldnt find random passable map position!"}getRandomEmptyPosition(){let t;for(let e=0;e<50;e++){let e=h.getItem(Object.values(this.tiles));this.isPassableEmptyAt(new tN(e.x,e.y))&&(t=new tN(e.x,e.y))}if(t)return t;throw"ERROR: couldnt find random passable empty map position!"}getEntitiesAt(t){let e=[];for(let i=0;i<this.entities.length;i++){let s=this.entities[i];s.position.equals(t)&&e.push(s)}return e}getFirstEntityAt(t){let e=this.getEntitiesAt(t);return e?e[0]:void 0}getCreatureEntityAt(t){let e;return this.getEntitiesAt(t).forEach(t=>{t.components.indexOf(tk.CREATURE)>=0&&(e=t)}),e}getItemEntityAt(t){for(let e=0;e<this.entities.length;e++){let i=this.entities[e];if(i.position.equals(t)&&i.hasAnyComponent(tI))return i}}removeDeadCreatures(){let t=[];this.eachEntity((e,i)=>{e.hasComponent(tk.CREATURE)&&!e.isAlive()&&t.push(i)}),t.forEach(t=>this.entities.splice(t,1))}removeEntity(t){this.entities.splice(this.entities.indexOf(t),1)}eachEntity(t){this.entities.forEach(t)}eachEntityWithComponent(t,e){this.entities.filter(e=>e.hasComponent(t)).forEach(e)}computeFovAt(t){let e=new tm((t,e)=>{let i=t+","+e;return i in this.tiles&&this.tiles[i].passable},{}),i=new Map;return e.compute(t.x,t.y,10,(t,e,s,r)=>i[tN.encode(t,e)]=new tN(t,e)),i}}class tF{constructor(t,e,i,s,r,o){this.range=t,this.damageMin=e,this.damageMax=i,this.soundHit=s,this.type=r,this.description=o}rollDamage(){return h.getUniformInt(this.damageMin,this.damageMax)}}let tY=new tF(1,5,12,null,tP.NONE,"claws"),t$=new tF(1,5,20,null,tP.STAFF,"staff"),tB=new tF(2,15,60,null,tP.GAUNTLETS,"gauntlets"),tH=new tF(10,7,14,null,tP.ELVEN_WAND,"elven wand");function tG(t){switch(t){case tP.NONE:return tY;case tP.STAFF:return t$;case tP.GAUNTLETS:return tB;case tP.ELVEN_WAND:return tH;default:throw"Unknown weapon"}}class tq{constructor(t,e,i){this.fg="#ccc",this.bg="#333",this.health=10,this.armor=0,this.passable=!1,this.weapon=tP.NONE,this.angered=!1,this.inventory=new tz,this.name=t,this.components=i,this.glyf=e}isAlive(){return this.health>0}description(){return this.name}hasComponent(t){return this.components.indexOf(t)>=0}hasAnyComponent(t){let e=!1;return t.forEach(t=>{this.components.indexOf(t)>=0&&(e=!0)}),e}hasAi(){return this.hasComponent(tk.AI)}isPlayer(){return this.hasComponent(tk.PLAYER)}damage(t){if(this.armor>0){let e=Math.floor(t/2);this.armor-=e,t-=e,this.armor<0&&(this.armor=0)}this.health-=t,this.health<0&&(this.health=0),this.angered=!0}weaponDescription(){return tG(this.weapon).description}}var tV=((o={})[o.NORMAL=0]="NORMAL",o[o.LOOK=1]="LOOK",o[o.TARGET=2]="TARGET",o[o.HELP=3]="HELP",o[o.INVENTORY=4]="INVENTORY",o);function tj(){let t=new tq("Crystal Vial","v",[tk.HEALTH_BONUS]);return t.passable=!0,t.fg=tR,t}function tK(){let t=new tq("Silver Shield","â",[tk.ARMOR_BONUS_1]);return t.passable=!0,t.fg=tM,t}function tJ(){let t=new tq("Enchanted Shield","Â",[tk.ARMOR_BONUS_2]);return t.passable=!0,t.fg=tM,t}function tQ(){let t=new tq("Gargoyle","G",[tk.CREATURE,tk.AI]);return t.health=40,t.fg="#f00",t}function tZ(){let t=new tq("Wand Crystal","ẇ",[tk.AMMO_WAND]);return t.passable=!0,t.fg=tO,t}function t1(){let t=new tq("Gauntlets of the Necromancer","g",[tk.GAUNTLETS]);return t.passable=!0,t.fg=tM,t}class t0{initLooker(){let t=new tq("Looker","@",[]);t.passable=!1,t.glyf="@",t.fg="#000",t.bg="#fff",t.position=new tN(this.player.position.x,this.player.position.y),this.looker=t}findNearestTarget(){let t,e=this.player.position,i=9999;return this.fov&&Object.values(this.fov).forEach(s=>{let r=this.world.getCreatureEntityAt(s);r&&e.distanceTo(s)<i&&(i=e.distanceTo(s),t=r)}),t}initTargeter(){let t=new tq("Targeter","@",[]);this.targeter=t,t.passable=!1,t.fg="#000",t.bg="#fff";let e=this.findNearestTarget();if(e){let i=this.player.position.distanceTo(e.position);if(tG(this.player.weapon).range>=i){t.position=new tN(e.position.x,e.position.y),t.glyf=e.glyf;return}}t.position=new tN(this.player.position.x,this.player.position.y)}computePlayerFov(){this.fov=this.world.computeFovAt(this.player.position)}positionInFov(t){return t.encoded()in this.fov}isPlayerOnStairs(){return this.world.getTileAt(this.player.position).type==tW.STAIRS}initNewMap(){console.log("initNewMap"),this.world=new tX(80,30),this.player.position=this.world.getRandomPassablePosition(),this.initTargeter(),this.world.entities.push(this.player),this.initRandomlyPlacedEntities(2,4,tQ),this.initRandomlyPlacedEntities(0,2,tj),this.initRandomlyPlacedEntities(1,1,tK),this.initRandomlyPlacedEntities(0,1,tJ),this.initRandomlyPlacedEntities(1,1,tZ),this.initRandomlyPlacedEntities(1,1,t1)}initNewPlayer(){let t=new tq("Player","@",[tk.PLAYER]);t.health=100,t.weapon=tP.ELVEN_WAND,t.inventory.wandAmmo=10,this.player=t}initRandomlyPlacedEntities(t,e,i){for(let s=0;s<h.getUniformInt(t,e);s++){let t=i();t.position=this.world.getRandomEmptyPosition(),this.world.entities.push(t)}}constructor(){this.turn=0,this.messages=[],this.mode=0,this.floorsDescended=0}}function t2(t,e){for(let i=0;i<80;i++)t.draw(i,e," ","#000","#000")}function t5(t,e){t.draw(e.position.x,e.position.y,e.glyf,e.fg,e.bg)}function t3(t,e){for(let i=-3;i+3<e.length;i++)t.drawText(0,34+i,e[i+3].content)}function t4(t){var e,i;if(t.mode==tV.HELP)(e=t.display).clear(),e.drawText(0,0,"Help"),e.drawText(0,1,"===="),e.drawText(0,3,"Stats: Hp=health, Ar=armor, Eq=equipped weapon (ammo range damage)"),e.drawText(0,5,"Movement: (arrow keys) (Moving into an enemy attacks with the staff)"),e.drawText(0,7,"Attack: a"),e.drawText(0,9,"Descend stairs: d"),e.drawText(0,11,"Cancel: ESC key"),e.drawText(0,13,"Confirm: RETURN key (or ENTER)");else switch(t3(t.display,t.messages),!function(t,e){for(let[i,s]of Object.entries(e.tiles)){let i=e.isMapPassableAt(new tN(s.x,s.y)),r="#080604";s.seen&&i?r="#111":s.seen&&!i&&(r="#222"),t.draw(s.x,s.y,1==s.type?"#":" ",r,r)}}(t.display,t.world),Object.values(t.fov).forEach(e=>{let i=t.world.getTileAt(e);i.seen=!0;let s=function(t){switch(t.type){case tW.DOOR:case tW.FLOOR:case tW.STAIRS:return"#333";case tW.WALL:return tS}}(i),r=function(t){switch(t.type){case tW.DOOR:case tW.FLOOR:case tW.STAIRS:return"#aaa";case tW.WALL:return tS}}(i);t.display.draw(e.x,e.y,i.glyf(),r,s);let o=t.world.getFirstEntityAt(e);o&&t5(t.display,o)}),t.mode){case tV.LOOK:let s,r,o,n,a;t5(t.display,t.looker),i=t.display,t2(i,30),s=t.world,r=t.looker.position,o=s.getFirstEntityAt(r),n=s.getTileAt(r),a="unknown",a=o?o.description():n.description(),i.drawText(0,30,`: ${a}`,80);break;case tV.TARGET:t5(t.display,t.targeter);break;case tV.NORMAL:let l,h,c,u,d,p,g,_,f;l=t.display,h=t.player,t2(l,30),c=`%c{${tR}}Hp: ${h.health} %c{grey}\u{1C2}`,u=`%c{${tM}}Ar: ${h.armor} %c{grey}\u{1C2}`,d=tG(h.weapon),p="",0>[tP.NONE,tP.STAFF,tP.GAUNTLETS].indexOf(d.type)&&(p=`: %c{${tO}}${t.player.inventory.getAmmo(h.weapon)}`),g=`range: ${d.range} `,_=`damage: ${d.damageMin}-${d.damageMax}`,f=`%c{${tO}}${d.description}${p} %c{grey}(${g}${_})`,l.drawText(0,30,`${c} ${u} ${f}`,80)}}function t6(t,e){console.log(t),e.unshift(new tU(t)),e.length>3&&e.pop()}function t8(t,e,i){let s=t,r=e;switch(i){case 38:r-=1;break;case 40:r+=1;break;case 37:s-=1;break;case 39:s+=1}return new tN(s,r)}function t9(t){let e=t.world.getCreatureEntityAt(t.targeter.position);if(e){let i=t.player.inventory.getAmmo(t.player.weapon);if(0!=i){let s=tG(t.player.weapon).rollDamage();e.damage(s),e.health<=0?t6(e.name+" dies",t.messages):t6(`you inflict ${s} damage on ${e.name}`,t.messages),i>0&&t.player.inventory.decAmmo(t.player.weapon)}else t6("%c{blue}You're out of ammo!",t.messages)}}window.onload=()=>{let t,e=(t=new t0,h.setSeed(1234),t.display=new t_({width:80,height:34,fontSize:24}),t.initNewPlayer(),t.initNewMap(),t);document.getElementById("canvas-container").appendChild(e.display.getContainer()),document.addEventListener("keydown",t=>(function(t,e){let i;s=t.messages,i=[],s.forEach((t,e)=>{t.age++,t.age>4&&i.push(e)}),i.forEach(t=>s.splice(t,1));var s,r=t.display;for(let t=-3;t<0;t++)t2(r,34+t);if(!t.player.isAlive()){t6("%c{blue}Reload the page to start over",t.messages),t3(t.display,t.messages);return}if(function(t,e){if(190==e)return!0;if(65==e)t.mode=tV.TARGET,t.initTargeter();else if(13==e&&t.mode==tV.TARGET)return t9(t),t.mode=tV.NORMAL,!0;else if(76==e)t.mode=tV.LOOK,t.initLooker();else if(27==e)t.mode=tV.NORMAL;else if(68==e&&t.isPlayerOnStairs())t.floorsDescended++,t.initNewMap();else if(t.mode==tV.NORMAL&&tC.includes(e)){let i=t8(t.player.position.x,t.player.position.y,e),s=t.world.getTileAt(i);if(t.world.isPassableAt(i)){t.player.position.set(i.x,i.y);let e=t.world.getItemEntityAt(i);e&&function(t,e){let i=!1;if(e.hasComponent(tk.HEALTH_BONUS)&&t.player.health<100){let e=100-t.player.health;e>10&&(e=10),t.player.health+=e,t6(`%c{${tR}}you gain ${e} health`,t.messages),i=!0}else if(e.hasComponent(tk.ARMOR_BONUS_1)&&t.player.armor<100)t.player.armor=100,t6(`%c{${tM}}equipped ${e.description()}`,t.messages),i=!0;else if(e.hasComponent(tk.ARMOR_BONUS_2)&&t.player.armor<200)t.player.armor=200,t6(`%c{${tM}}equipped ${e.description()}`,t.messages),i=!0;else if(e.hasComponent(tk.AMMO_WAND)&&t.player.inventory.wandAmmo<100){let s=100-t.player.inventory.wandAmmo;s>10&&(s=10),t.player.inventory.addAmmo(tP.ELVEN_WAND,s),t6(`%c{${tO}}picked up ${e.description()} (+${s})`,t.messages),i=!0}else e.hasComponent(tk.GAUNTLETS)&&0>t.player.inventory.weapons.indexOf(tP.GAUNTLETS)&&(t.player.inventory.weapons.push(tP.GAUNTLETS),t.player.weapon=tP.GAUNTLETS,t6(`%c{${tM}}picked up ${e.description()}`,t.messages),t.world.removeEntity(e));i&&t.world.removeEntity(e)}(t,e),h.getUniform()}else if(s.type!=tW.DOOR||s.passable){if(!t.world.isEntitiesPassableAt(i)){let e=t.world.getCreatureEntityAt(i);e.isPlayer()||(0==t.player.inventory.getAmmo(t.player.weapon)&&(t6("%c{blue}out of ammo! attacking with staff instead",t.messages),t.player.weapon=tP.STAFF),t.targeter.position.set(e.position.x,e.position.y),t9(t))}}else s.passable=!0;return!0}else t.mode==tV.LOOK&&tC.includes(e)?function(t,e){let i=t8(t.looker.position.x,t.looker.position.y,e),s=t.world,r=t.looker;if(t.positionInFov(i)){r.position.set(i.x,i.y);let t=s.getEntitiesAt(i),e=t?t[0]:void 0;e?r.glyf=e.glyf:r.glyf=""}}(t,e):t.mode==tV.TARGET&&tC.includes(e)?function(t,e){let i=t8(t.targeter.position.x,t.targeter.position.y,e),s=t.world,r=t.targeter,o=t.player;if(o.position.distanceTo(i)<=tG(o.weapon).range&&s.isMapPassableAt(i)&&i.encoded()in t.fov){r.position.set(i.x,i.y);let t=s.getEntitiesAt(i),e=t?t[0]:void 0;e?r.glyf=e.glyf:r.glyf=""}}(t,e):49==e?(t.player.weapon=tP.STAFF,t6(`%c{${tO}}equipped Staff`,t.messages)):50==e?t.player.inventory.weapons.indexOf(tP.GAUNTLETS)>=0?(t.player.weapon=tP.GAUNTLETS,t6(`%c{${tO}}equipped Gauntlets of the Necromancer`,t.messages)):t6("you don't have that weapon yet",t.messages):51==e?(t.player.weapon=tP.ELVEN_WAND,t6(`%c{${tO}}equipped Elven Wand`,t.messages)):72==e&&(t.mode=tV.HELP);return!1}(t,e)){let e,i;t.turn++,t.world.removeDeadCreatures(),i=new tv((e=t.player).position.x,e.position.y,(e,i)=>t.world.isMapPassableAt(new tN(e,i)),{}),t.world.eachEntityWithComponent(tk.AI,s=>{if(s.isPlayer()||!s.isAlive()||!s.hasAi())return;let r=[];if(i.compute(s.position.x,s.position.y,(t,e)=>{r.push(new tN(t,e))}),2===r.length){let i=h.getUniformInt(5,12);e.damage(i),t6(`%c{${tR}}${s.name} scrapes you for ${i} damage!`,t.messages)}else(r.length>2&&r.length<6||s.angered)&&h.getUniform()>.25&&((r=r.reverse()).pop(),s.position=r.pop())}),t.player.isAlive()||(t.messages=[],t6(`%c{red}You died after descending ${t.floorsDescended} floors.`,t.messages))}t.computePlayerFov(),t4(t)})(e,t.keyCode)),t6("press 'h' for help",e.messages),e.computePlayerFov(),t4(e)};